{% extends "base.html" %}

{% block title %}Musique - Spotify Controller - SOS Thomas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-bold text-gray-800">Musique (Spotify)</h2>
        <a href="{{ url_for('dashboard') }}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
            <i class="fas fa-arrow-left mr-2"></i>Retour
        </a>
    </div>
    
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="text-center">
            <!-- Message d'avertissement configuration -->
            <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h4 class="text-lg font-semibold text-yellow-800 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Configuration Spotify requise
                </h4>
                <p class="text-yellow-700 mb-3">
                    Pour utiliser le contrôleur Spotify, configurez vos identifiants dans votre profil utilisateur.
                </p>
                <div class="text-left bg-yellow-100 p-3 rounded border border-yellow-300">
                    <p class="text-sm font-semibold text-yellow-800 mb-2">Étapes à suivre :</p>
                    <ol class="text-sm text-yellow-700 list-decimal list-inside space-y-1">
                        <li>Allez dans votre <a href="{{ url_for('profile') }}" class="underline font-semibold">profil utilisateur</a></li>
                        <li>Ouvrez l'onglet "Services"</li>
                        <li>Créez une application sur <a href="https://developer.spotify.com/dashboard" target="_blank" class="underline">Spotify Developer Dashboard</a></li>
                        <li>Ajoutez le redirect URI : <code class="bg-yellow-200 px-1">http://localhost:5000/callback</code></li>
                        <li>Entrez vos Client ID et Client Secret dans votre profil</li>
                        <li>Revenez ici pour vous connecter à Spotify</li>
                    </ol>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('profile') }}" class="inline-block bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                        <i class="fas fa-user-cog mr-2"></i>Configurer mon profil
                    </a>
                </div>
            </div>
            
            <!-- État de connexion -->
            <div id="connectionStatus" class="mb-6">
                <i class="fas fa-music text-6xl text-green-600 mb-4"></i>
                <h3 class="text-xl font-semibold mb-4">Connexion Spotify</h3>
                <p class="text-gray-600 mb-6">Connectez votre compte Spotify pour contrôler votre musique</p>
                
                <button id="connectBtn" onclick="connectSpotify()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 mb-6">
                    <i class="fab fa-spotify mr-2"></i>Se connecter à Spotify
                </button>
                
                <button id="disconnectBtn" onclick="disconnectSpotify()" class="hidden bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 mb-6">
                    <i class="fas fa-sign-out-alt mr-2"></i>Se déconnecter
                </button>
            </div>
            
            <!-- Lecteur Spotify -->
            <div id="spotifyPlayer" class="hidden">
                <!-- Pochette et informations -->
                <div class="mb-6">
                    <div class="flex justify-center mb-4">
                        <img id="albumCover" src="" alt="Pochette d'album" class="w-64 h-64 rounded-lg shadow-lg object-cover">
                    </div>
                    <div class="text-center">
                        <h3 id="trackName" class="text-2xl font-bold text-gray-800 mb-2">Chargement...</h3>
                        <p id="artistName" class="text-lg text-gray-600 mb-1">Chargement...</p>
                        <p id="albumName" class="text-md text-gray-500">Chargement...</p>
                    </div>
                </div>
                
                <!-- Barre de progression -->
                <div class="mb-6">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600 mt-1">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>
                
                <!-- Contrôles de lecture -->
                <div class="flex justify-center items-center space-x-4 mb-6">
                    <button onclick="previousTrack()" class="bg-gray-600 text-white p-3 rounded-full hover:bg-gray-700 transition-colors">
                        <i class="fas fa-backward text-lg"></i>
                    </button>
                    
                    <button id="playPauseBtn" onclick="togglePlayPause()" class="bg-green-600 text-white p-4 rounded-full hover:bg-green-700 transition-colors">
                        <i id="playPauseIcon" class="fas fa-play text-xl"></i>
                    </button>
                    
                    <button onclick="nextTrack()" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition-colors">
                        <i class="fas fa-forward text-lg"></i>
                    </button>
                </div>
                
                <!-- Bouton de rafraîchissement -->
                <div class="flex justify-center">
                    <button onclick="refreshCurrentTrack()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        <i class="fas fa-sync-alt mr-2"></i>Rafraîchir
                    </button>
                </div>
            </div>
            
            <!-- Messages d'erreur -->
            <div id="errorMessage" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="errorText"></span>
            </div>
            
            <!-- Messages de succès -->
            <div id="successMessage" class="hidden mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="successText"></span>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="mt-8 bg-blue-50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-blue-800 mb-4">
            <i class="fas fa-info-circle mr-2"></i>Instructions d'utilisation
        </h3>
        <ul class="list-disc list-inside text-blue-700 space-y-2">
            <li>Cliquez sur "Se connecter à Spotify" pour autoriser l'application</li>
            <li>Vous devez avoir un compte Spotify Premium pour contrôler la lecture</li>
            <li>Assurez-vous d'avoir Spotify ouvert sur un appareil (mobile, desktop, etc.)</li>
            <li>Utilisez les boutons pour contrôler la lecture</li>
            <li>L'application se mettra à jour automatiquement toutes les 5 secondes</li>
        </ul>
    </div>
</div>

<script>
let isPlaying = false;
let updateInterval = null;

// Vérifier la connexion au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    checkConnection();
});

function checkConnection() {
    fetch('/api/spotify/current')
        .then(response => {
            if (response.ok) {
                showPlayer();
                updateCurrentTrack();
                startAutoUpdate();
            } else {
                showConnectionScreen();
            }
        })
        .catch(error => {
            showConnectionScreen();
        });
}

function connectSpotify() {
    window.location.href = '/spotify/login';
}

function disconnectSpotify() {
    // Effacer la session côté serveur (nécessite une route supplémentaire)
    showConnectionScreen();
    stopAutoUpdate();
    showMessage('Déconnecté de Spotify', 'success');
}

function showConnectionScreen() {
    document.getElementById('connectionStatus').classList.remove('hidden');
    document.getElementById('spotifyPlayer').classList.add('hidden');
    document.getElementById('connectBtn').classList.remove('hidden');
    document.getElementById('disconnectBtn').classList.add('hidden');
}

function showPlayer() {
    document.getElementById('connectionStatus').classList.add('hidden');
    document.getElementById('spotifyPlayer').classList.remove('hidden');
    document.getElementById('disconnectBtn').classList.remove('hidden');
}

function updateCurrentTrack() {
    fetch('/api/spotify/current')
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    showMessage('Session expirée, veuillez vous reconnecter', 'error');
                    showConnectionScreen();
                    stopAutoUpdate();
                } else if (response.status === 404) {
                    showMessage('Aucune lecture en cours', 'error');
                    clearTrackInfo();
                }
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data && !data.error) {
                updateTrackDisplay(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Erreur de connexion à Spotify', 'error');
        });
}

function updateTrackDisplay(track) {
    // Mettre à jour les informations de la piste
    document.getElementById('trackName').textContent = track.name || 'Inconnue';
    document.getElementById('artistName').textContent = track.artist || 'Artiste inconnu';
    document.getElementById('albumName').textContent = track.album || 'Album inconnu';
    
    // Mettre à jour la pochette
    const albumCover = document.getElementById('albumCover');
    if (track.image) {
        albumCover.src = track.image;
        albumCover.classList.remove('hidden');
    } else {
        albumCover.classList.add('hidden');
    }
    
    // Mettre à jour l'état de lecture
    isPlaying = track.is_playing || false;
    updatePlayPauseButton();
    
    // Mettre à jour la barre de progression
    if (track.progress_ms !== undefined && track.duration_ms) {
        const progress = (track.progress_ms / track.duration_ms) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('currentTime').textContent = formatTime(track.progress_ms);
        document.getElementById('totalTime').textContent = formatTime(track.duration_ms);
    }
}

function clearTrackInfo() {
    document.getElementById('trackName').textContent = 'Aucune lecture en cours';
    document.getElementById('artistName').textContent = '';
    document.getElementById('albumName').textContent = '';
    document.getElementById('albumCover').classList.add('hidden');
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('currentTime').textContent = '0:00';
    document.getElementById('totalTime').textContent = '0:00';
}

function togglePlayPause() {
    const action = isPlaying ? 'pause' : 'play';
    
    fetch(`/api/spotify/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            isPlaying = !isPlaying;
            updatePlayPauseButton();
            // Petite pause avant de rafraîchir pour laisser le temps à Spotify de traiter
            setTimeout(updateCurrentTrack, 500);
        } else {
            showMessage('Erreur lors du contrôle de la lecture', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Erreur de connexion', 'error');
    });
}

function updatePlayPauseButton() {
    const icon = document.getElementById('playPauseIcon');
    icon.className = isPlaying ? 'fas fa-pause text-xl' : 'fas fa-play text-xl';
}

function previousTrack() {
    fetch('/api/spotify/previous', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            setTimeout(updateCurrentTrack, 500);
        } else {
            showMessage('Erreur lors du passage à la piste précédente', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Erreur de connexion', 'error');
    });
}

function nextTrack() {
    fetch('/api/spotify/next', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            setTimeout(updateCurrentTrack, 500);
        } else {
            showMessage('Erreur lors du passage à la piste suivante', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Erreur de connexion', 'error');
    });
}

function refreshCurrentTrack() {
    updateCurrentTrack();
    showMessage('Informations mises à jour', 'success');
}

function startAutoUpdate() {
    // Mettre à jour toutes les 5 secondes
    updateInterval = setInterval(updateCurrentTrack, 5000);
}

function stopAutoUpdate() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

function formatTime(ms) {
    if (!ms) return '0:00';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function showMessage(message, type) {
    const errorDiv = document.getElementById('errorMessage');
    const successDiv = document.getElementById('successMessage');
    const errorText = document.getElementById('errorText');
    const successText = document.getElementById('successText');
    
    // Cacher les deux messages
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    
    // Afficher le message approprié
    if (type === 'error') {
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
        // Cacher automatiquement après 5 secondes
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    } else if (type === 'success') {
        successText.textContent = message;
        successDiv.classList.remove('hidden');
        // Cacher automatiquement après 3 secondes
        setTimeout(() => {
            successDiv.classList.add('hidden');
        }, 3000);
    }
}

// Nettoyer l'intervalle lors de la fermeture de la page
window.addEventListener('beforeunload', function() {
    stopAutoUpdate();
});
</script>
{% endblock %}
