{% extends "base.html" %}

{% block title %}T√¢ches - SOS Thomas{% endblock %}

{% block extra_css %}
<style>
.task-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}
.task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
.task-card.priority-haute {
    border-left-color: #ef4444;
}
.task-card.priority-moyenne {
    border-left-color: #f59e0b;
}
.task-card.priority-basse {
    border-left-color: #10b981;
}
.task-card.completed {
    opacity: 0.7;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}
.sort-controls select {
    background-color: rgba(255, 255, 255, 0.95);
    color: #1f2937;
    border: 1px solid rgba(255, 255, 255, 0.3);
}
.sort-controls select:focus {
    background-color: white;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.priority-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.task-checkbox {
    width: 1.5rem;
    height: 1.5rem;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: white;
}
.task-checkbox:hover {
    border-color: #9ca3af;
    transform: scale(1.05);
}
.task-checkbox.checked {
    border-color: #10b981;
    background-color: #f0fdf4;
}
.empty-state {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px dashed #f59e0b;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <div>
            <h2 class="text-4xl font-bold text-gray-800 mb-2">üìã Suivi de t√¢ches</h2>
            <p class="text-gray-600">G√©rez vos t√¢ches quotidiennes avec efficacit√©</p>
        </div>
    </div>
    
    <!-- Formulaire d'ajout unifi√© -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Ajouter une nouvelle t√¢che</h3>
        <form method="POST" id="taskForm">
            <div class="space-y-4">
                <!-- S√©lecteur de type de t√¢che -->
                <div class="flex gap-4 mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="task_type" value="general" checked class="mr-2">
                        <span class="text-gray-700">T√¢che g√©n√©rale</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="task_type" value="project" class="mr-2">
                        <span class="text-gray-700">T√¢che de projet</span>
                    </label>
                </div>
                
                <!-- Champs communs -->
                <div class="flex flex-wrap gap-4">
                    <input type="text" name="task_name" placeholder="Entrez votre t√¢che..." 
                           class="border-2 border-gray-300 rounded-lg px-4 py-3 flex-1 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" required>
                    <select name="task_priority" class="border-2 border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="basse">Basse</option>
                        <option value="moyenne" selected>Moyenne</option>
                        <option value="haute">Haute</option>
                    </select>
                </div>
                
                <!-- Champ projet (visible seulement pour les t√¢ches de projet) -->
                <div id="project_field" class="hidden">
                    <select name="project_id" class="border-2 border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="">S√©lectionner un projet...</option>
                        {% for project in data.projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Champ statut (visible seulement pour les t√¢ches de projet) -->
                <div id="status_field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Statut de la t√¢che</label>
                    <select name="task_status" class="border-2 border-gray-300 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="a-faire">√Ä faire</option>
                        <option value="en-cours">En cours</option>
                        <option value="termin√©">R√©alis√©e</option>
                    </select>
                </div>
                
                <!-- Boutons -->
                <div class="flex gap-3">
                    <button type="submit" id="submit_general" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-plus mr-2"></i>Ajouter la t√¢che
                    </button>
                    <button type="submit" id="submit_project" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-teal-700 transition-all duration-200 shadow-lg hover:shadow-xl hidden">
                        <i class="fas fa-project-diagram mr-2"></i>Ajouter au projet
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Contr√¥les de tri -->
    <div class="sort-controls rounded-xl shadow-lg p-6 mb-8 text-white">
        <div class="flex flex-wrap justify-between items-center">
            <div>
                <h3 class="text-xl font-semibold mb-4">Trier les t√¢ches</h3>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center gap-2">
                        <label for="sort_by" class="font-medium">Trier par:</label>
                        <select id="sort_by" onchange="sortTasks()" class="rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Date de cr√©ation</option>
                            <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priorit√©</option>
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nom</option>
                            <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Statut</option>
                            <option value="project" {% if sort_by == 'project' %}selected{% endif %}>Projet</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="sort_order" class="font-medium">Ordre:</label>
                        <select id="sort_order" onchange="sortTasks()" class="rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Croissant</option>
                            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>D√©croissant</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                {% if show_completed %}
                    <button onclick="toggleCompletedTasks()" class="bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-eye-slash mr-2"></i>Masquer les t√¢ches r√©alis√©es
                    </button>
                {% else %}
                    <button onclick="toggleCompletedTasks()" class="bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-eye mr-2"></i>Voir les t√¢ches r√©alis√©es
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Liste des t√¢ches -->
    <div class="space-y-4">
        {% for task in data.all_tasks %}
            <div class="task-card bg-white rounded-xl shadow-md p-6 {{ 'priority-' + task.priority }} {{ 'completed' if task.completed else '' }}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        {% if task.task_type == 'general' %}
                            <a href="#" onclick="toggleTaskStatus('{{ task.id }}', event)" class="mr-4">
                                <div class="task-checkbox {{ 'checked' if task.completed else '' }}">
                                    {% if task.completed %}
                                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                            <path d="M2 6L4.5 8.5L10 3" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    {% endif %}
                                </div>
                            </a>
                        {% else %}
                            <a href="#" onclick="toggleTaskStatus('{{ task.id }}', event)" class="mr-4">
                                <div class="task-checkbox {{ 'checked' if task.completed else '' }}">
                                    {% if task.completed %}
                                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                            <path d="M2 6L4.5 8.5L10 3" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    {% endif %}
                                </div>
                            </a>
                        {% endif %}
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold {{ 'line-through text-gray-500' if task.completed else 'text-gray-800' }}">
                                {{ task.name }}
                            </h4>
                            <div class="flex items-center gap-3 mt-2">
                                {% if task.task_type == 'project' %}
                                    <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 border border-blue-200">
                                        <i class="fas fa-project-diagram mr-1"></i>{{ task.project_name }}
                                    </span>
                                {% else %}
                                    <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800 border border-gray-200">
                                        <i class="fas fa-tasks mr-1"></i>G√©n√©rale
                                    </span>
                                {% endif %}
                                <span class="priority-badge 
                                    {% if task.priority == 'haute' %}bg-red-100 text-red-800 border border-red-200
                                    {% elif task.priority == 'moyenne' %}bg-yellow-100 text-yellow-800 border border-yellow-200
                                    {% else %}bg-green-100 text-green-800 border border-green-200{% endif %}">
                                    {% if task.priority == 'haute' %}üî¥ Haute
                                    {% elif task.priority == 'moyenne' %}üü° Moyenne
                                    {% else %}üü¢ Basse{% endif %}
                                </span>
                                <span class="text-sm text-gray-500">
                                    <i class="far fa-calendar mr-1"></i>
                                    {{ task.created_at[:10] if task.created_at else 'N/A' }}
                                </span>
                                {% if task.completed %}
                                <span class="text-sm text-green-600 font-medium">
                                    <i class="fas fa-check-circle mr-1"></i>R√©alis√©e
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        {% if task.task_type == 'general' %}
                            <a href="{{ url_for('delete_item', item_type='tasks', item_id=task.id) }}" 
                               class="text-red-500 hover:text-red-700 transition-colors duration-200 p-2 rounded-lg hover:bg-red-50"
                               onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?')">
                                <i class="fas fa-trash text-lg"></i>
                            </a>
                        {% else %}
                            <a href="#" onclick="editProjectTask('{{ task.id }}', '{{ task.name }}', '{{ task.priority }}', '{{ task.project_id }}')" 
                               class="text-blue-500 hover:text-blue-700 transition-colors duration-200 p-2 rounded-lg hover:bg-blue-50">
                                <i class="fas fa-edit text-lg"></i>
                            </a>
                            <a href="#" onclick="deleteProjectTask('{{ task.id }}')" 
                               class="text-red-500 hover:text-red-700 transition-colors duration-200 p-2 rounded-lg hover:bg-red-50"
                               onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che de projet ?')">
                                <i class="fas fa-trash text-lg"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="empty-state rounded-xl p-12 text-center">
                <i class="fas fa-clipboard-list text-6xl text-yellow-600 mb-4"></i>
                <h3 class="text-2xl font-bold text-yellow-800 mb-2">Aucune t√¢che enregistr√©e</h3>
                <p class="text-yellow-700">Commencez par ajouter votre premi√®re t√¢che ci-dessus !</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Modal d'√©dition de t√¢che de projet -->
<div id="editTaskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Modifier la t√¢che de projet</h3>
        <form id="editTaskForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la t√¢che</label>
                    <input type="text" id="editTaskName" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Priorit√©</label>
                    <select id="editTaskPriority" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="basse">Basse</option>
                        <option value="moyenne">Moyenne</option>
                        <option value="haute">Haute</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Projet</label>
                    <select id="editTaskProject" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        {% for project in data.projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    Annuler
                </button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentEditingTaskId = null;

// G√©rer le changement de type de t√¢che
document.addEventListener('DOMContentLoaded', function() {
    const taskTypeRadios = document.querySelectorAll('input[name="task_type"]');
    const projectField = document.getElementById('project_field');
    const statusField = document.getElementById('status_field');
    const submitGeneral = document.getElementById('submit_general');
    const submitProject = document.getElementById('submit_project');
    const taskForm = document.getElementById('taskForm');
    
    taskTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'project') {
                projectField.classList.remove('hidden');
                statusField.classList.remove('hidden');
                submitGeneral.classList.add('hidden');
                submitProject.classList.remove('hidden');
            } else {
                projectField.classList.add('hidden');
                statusField.classList.add('hidden');
                submitGeneral.classList.remove('hidden');
                submitProject.classList.add('hidden');
            }
        });
    });
    
    // G√©rer la soumission du formulaire
    taskForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const taskType = document.querySelector('input[name="task_type"]:checked').value;
        const taskName = document.querySelector('input[name="task_name"]').value;
        const taskPriority = document.querySelector('select[name="task_priority"]').value;
        
        if (taskType === 'project') {
            const projectId = document.querySelector('select[name="project_id"]').value;
            const taskStatus = document.querySelector('select[name="task_status"]').value;
            
            if (!projectId) {
                alert('Veuillez s√©lectionner un projet');
                return;
            }
            
            // Cr√©er une t√¢che de projet
            const formData = new FormData();
            formData.append('name', taskName);
            formData.append('priority', taskPriority);
            formData.append('project_id', projectId);
            formData.append('status', taskStatus);
            
            fetch('{{ url_for('add_project_task_from_tasks') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de l\'ajout');
            });
        } else {
            // Cr√©er une t√¢che g√©n√©rale
            const formData = new FormData();
            formData.append('name', taskName);
            formData.append('priority', taskPriority);
            
            fetch('{{ url_for('add_task') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de l\'ajout');
            });
        }
    });
});

function toggleCompletedTasks() {
    {% if show_completed %}
        window.location.href = "{{ url_for('taches') }}";
    {% else %}
        window.location.href = "{{ url_for('taches') }}?show_completed=true";
    {% endif %}
}

function toggleTaskStatus(taskId, event) {
    event.preventDefault();
    
    fetch(`/api/toggle-task/${taskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animation de disparition de la t√¢che
            const taskCard = event.target.closest('.task-card');
            taskCard.style.transition = 'all 0.3s ease';
            taskCard.style.opacity = '0.5';
            taskCard.style.transform = 'translateX(20px)';
            
            // Attendre l'animation puis recharger
            setTimeout(() => {
                location.reload();
            }, 300);
        } else {
            alert('Erreur lors de la mise √† jour');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour');
    });
}

function sortTasks() {
    const sortBy = document.getElementById('sort_by').value;
    const sortOrder = document.getElementById('sort_order').value;
    window.location.href = `{{ url_for('taches') }}?sort_by=${sortBy}&sort_order=${sortOrder}`;
}

function editProjectTask(taskId, taskName, taskPriority, projectId) {
    currentEditingTaskId = taskId;
    document.getElementById('editTaskName').value = taskName;
    document.getElementById('editTaskPriority').value = taskPriority;
    document.getElementById('editTaskProject').value = projectId;
    document.getElementById('editTaskModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editTaskModal').style.display = 'none';
    currentEditingTaskId = null;
}

function deleteProjectTask(taskId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che de projet ?')) {
        fetch(`/api/delete_task/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

function toggleProjectTaskStatus(taskId) {
    fetch(`/api/update_task_status/${taskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'completed'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur lors de la mise √† jour');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour');
    });
}

// G√©rer la soumission du formulaire d'√©dition
document.getElementById('editTaskForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskData = {
        name: document.getElementById('editTaskName').value,
        priority: document.getElementById('editTaskPriority').value,
        project_id: document.getElementById('editTaskProject').value
    };
    
    fetch(`/api/update_project_task/${currentEditingTaskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            location.reload();
        } else {
            alert('Erreur lors de la mise √† jour');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour');
    });
});
</script>
{% endblock %}
